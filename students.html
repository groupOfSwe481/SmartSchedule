<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="assets/js/auth-guard.js"></script>
  <title>Student Management - SmartSchedule</title>
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  
  <!-- استخدام ملف style.css الأساسي -->
  <link rel="stylesheet" href="assets/css/style.css" />
  
  <style>
    /* إضافات خاصة بصفحة Students فقط */
    .section-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      margin-bottom: 2rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }
    
    .level-input-group {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .level-label {
      min-width: 80px;
      font-weight: 600;
      color: #1e293b;
    }
    
    .level-input-group .form-control {
      max-width: 200px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    
    .level-input-group .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.1);
    }
    
    .course-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
      border-radius: 12px;
      margin-bottom: 0.75rem;
      border-left: 4px solid var(--primary);
      transition: all 0.2s ease;
    }
    
    .course-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }
    
    .course-code {
      font-weight: 700;
      color: var(--primary);
      min-width: 100px;
    }
    
    .course-name {
      flex: 1;
      color: #64748b;
    }
    
    .course-item .form-control {
      max-width: 120px;
    }
    
    .upload-area {
      border: 3px dashed #e2e8f0;
      border-radius: 16px;
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }
    
    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      transform: scale(1.02);
    }
    
    .btn {
      border-radius: 10px;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-outline-primary {
      border: 2px solid var(--primary);
      color: var(--primary);
      background: white;
    }
    
    .btn-outline-primary:hover {
      background: var(--primary);
      color: white;
    }
    
    .btn-outline-primary.active {
      background: var(--primary);
      color: white;
    }
    
    .btn-outline-danger {
      border: 2px solid #ef4444;
      color: #ef4444;
    }
    
    .btn-outline-danger:hover {
      background: #ef4444;
      color: white;
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    
    .form-control,
    .form-select {
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    
    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.1);
    }
    
    .form-select-lg {
      padding: 0.875rem 1rem;
    }
    
    .table {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .table thead {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .table thead th {
      color: #1e293b;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      padding: 1rem;
      border: none;
    }
    
    .table tbody td {
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
      vertical-align: middle;
    }
    
    .table-hover tbody tr:hover {
      background: rgba(99, 102, 241, 0.05);
    }
    
    .save-btn-fixed {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
    }
    
    .alert {
      border-radius: 12px;
      border: none;
    }
    
    .alert-info {
      background: rgba(6, 182, 212, 0.1);
      color: #0891b2;
    }
    
    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }
    
    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
    }
    
    .alert-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }
    
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-group .btn {
      border-radius: 10px !important;
    }
    
    .spinner-border {
      color: var(--primary);
    }
    
    .progress {
      height: 1.5rem;
      border-radius: 10px;
      background: #e2e8f0;
    }
    
    .progress-bar {
      background: var(--gradient-primary);
    }
    
    #alert-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      max-width: 400px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .main-container,
      .section-card {
        padding: 1rem;
      }
      
      .level-input-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .level-input-group .form-control {
        max-width: 100%;
      }
      
      .course-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .course-item .form-control {
        max-width: 100%;
      }
      
      .upload-area {
        padding: 1.5rem;
      }
      
      .btn-group {
        flex-direction: column;
        width: 100%;
      }
      
      .btn-group .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle">
    <i class="bi bi-list" style="font-size: 1.5rem; color: #6366f1"></i>
  </button>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="sidebar-brand">
        <i class="bi bi-calendar-check"></i>
        <span>SmartSchedule</span>
      </a>
    </div>
    
    <nav class="sidebar-nav">
      <ul style="list-style: none; padding: 0; margin: 0">
        <li class="sidebar-nav-item">
          <a href="index.html" class="sidebar-nav-link">
            <i class="bi bi-calendar3"></i>
            <span>Schedules</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="irregulars.html" class="sidebar-nav-link">
            <i class="bi bi-person-exclamation"></i>
            <span>Irregular Students</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="course-management.html" class="sidebar-nav-link">
            <i class="bi bi-folder-plus"></i>
            <span>Section Management</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="feedback.html" class="sidebar-nav-link">
            <i class="bi bi-chat-dots"></i>
            <span>Comments managment</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="faculty-electives.html" class="sidebar-nav-link">
            <i class="bi bi-bookmark-check"></i>
            <span>Elective course</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="students.html" class="sidebar-nav-link active">
            <i class="bi bi-people-fill"></i>
            <span>Students managment</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="rules.html" class="sidebar-nav-link">
            <i class="bi bi-sliders"></i>
            <span>Rules managment</span>
          </a>
        </li>
        <li class="sidebar-nav-item">
          <a href="version-history.html" class="sidebar-nav-link">
            <i class="bi bi-clock-history"></i>
            <span>versions control</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="sidebar-footer dropup">
      <div class="sidebar-user" id="sidebarUser" data-bs-toggle="dropdown" aria-expanded="false">
        <div class="sidebar-user-avatar" id="userAvatar">CM</div>
        <div class="sidebar-user-info">
          <div class="sidebar-user-name" id="sidebarUserName">Committee Member</div>
          <div class="sidebar-user-role">Faculty</div>
        </div>
      </div>
      <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="sidebarUser">
        <li>
          <a class="dropdown-item" href="#" id="logoutButton">Logout</a>
        </li>
      </ul>
    </div>
  </aside>

  <div class="main-wrapper">
    <header class="top-header">
      <h1><i class="bi bi-people-fill me-3"></i>Student Management</h1>
      <div class="top-header-actions">
        <button class="notification-btn" data-bs-toggle="modal" data-bs-target="#notificationsModal">
          <i class="bi bi-bell-fill"></i>
          <span class="notification-badge" id="notificationBadge">0</span>
        </button>
      </div>
    </header>

    <div class="main-container">
      <!-- Section 1: Level Student Counts -->
      <div class="section-card">
        <div class="section-title">
          <i class="bi bi-1-circle-fill text-primary me-2"></i>
          Student Count Per Level
        </div>
        <p class="text-muted mb-4">Enter the total number of students for each level (3-8)</p>

        <div class="row">
          <div class="col-md-6">
            <div class="level-input-group">
              <label class="level-label">Level 3:</label>
              <input type="number" class="form-control" id="level_3" min="0" placeholder="Enter student count" />
            </div>
            <div class="level-input-group">
              <label class="level-label">Level 4:</label>
              <input type="number" class="form-control" id="level_4" min="0" placeholder="Enter student count" />
            </div>
            <div class="level-input-group">
              <label class="level-label">Level 5:</label>
              <input type="number" class="form-control" id="level_5" min="0" placeholder="Enter student count" />
            </div>
            <div class="level-input-group">
              <label class="level-label">Level 6:</label>
              <input type="number" class="form-control" id="level_6" min="0" placeholder="Enter student count" />
            </div>
          </div>
          <div class="col-md-6">
            <div class="level-input-group">
              <label class="level-label">Level 7:</label>
              <input type="number" class="form-control" id="level_7" min="0" placeholder="Enter student count" />
            </div>
            <div class="level-input-group">
              <label class="level-label">Level 8:</label>
              <input type="number" class="form-control" id="level_8" min="0" placeholder="Enter student count" />
            </div>
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-primary" onclick="saveLevelCounts()">
            <i class="bi bi-save me-2"></i>Save Level Counts
          </button>
        </div>
      </div>

      <!-- Section 2: Course Student Counts -->
      <div class="section-card">
        <div class="section-title">
          <i class="bi bi-2-circle-fill text-success me-2"></i>
          Student Count Per Course
        </div>
        <p class="text-muted mb-4">Choose method: Upload file or manually enter counts</p>

        <!-- Method Selection -->
        <div class="btn-group mb-4" role="group">
          <input type="radio" class="btn-check" name="inputMethod" id="methodManual" checked />
          <label class="btn btn-outline-primary" for="methodManual">
            <i class="bi bi-pencil-square"></i> Manual Entry
          </label>

          <input type="radio" class="btn-check" name="inputMethod" id="methodUpload" />
          <label class="btn btn-outline-primary" for="methodUpload">
            <i class="bi bi-cloud-upload"></i> Upload File
          </label>
        </div>

        <!-- Manual Entry Section -->
        <div id="manualEntrySection">
          <div class="mb-3">
            <label class="form-label fw-semibold">Select Level to Load Courses:</label>
            <select class="form-select form-select-lg" id="courseLevel" onchange="loadCourses()">
              <option value="">-- Select a Level --</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
              <option value="5">Level 5</option>
              <option value="6">Level 6</option>
              <option value="7">Level 7</option>
              <option value="8">Level 8</option>
            </select>
          </div>

          <div id="coursesContainer">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Please select a level to load courses
            </div>
          </div>

          <div id="manualSaveBtn" style="display: none">
            <button class="btn btn-success" onclick="saveCourseCounts()">
              <i class="bi bi-save me-2"></i>Save Course Counts
            </button>
          </div>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" style="display: none">
          <div class="mb-3">
            <label class="form-label fw-semibold">Select Level for Upload:</label>
            <select class="form-select form-select-lg" id="uploadLevel">
              <option value="">-- Select a Level --</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
              <option value="5">Level 5</option>
              <option value="6">Level 6</option>
              <option value="7">Level 7</option>
              <option value="8">Level 8</option>
            </select>
          </div>

          <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept="image/*,.pdf" style="display: none" />
            <i class="bi bi-cloud-arrow-up-fill fs-1 text-primary mb-3"></i>
            <h5>Drag & Drop File Here or Click to Browse</h5>
            <p class="text-muted">Supported formats: PDF, JPG, PNG (Max 10MB)</p>
            <p class="text-muted"><small>File should contain course codes and student counts</small></p>

            <div id="fileInfo" class="mt-3" style="display: none">
              <div class="alert alert-success">
                <i class="bi bi-file-earmark-check me-2"></i>
                <strong id="fileName"></strong>
                <button type="button" class="btn btn-sm btn-danger float-end" onclick="removeFile()">
                  <i class="bi bi-x"></i> Remove
                </button>
              </div>
            </div>
          </div>

          <div id="uploadProgress" class="mt-3" style="display: none">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <p class="text-center mt-2">Processing file...</p>
          </div>

          <div class="mt-3">
            <button class="btn btn-success" id="uploadBtn" onclick="uploadFile()" disabled>
              <i class="bi bi-upload me-2"></i>Upload & Process
            </button>
          </div>
        </div>
      </div>

      <!-- Current Data Display -->
      <div class="section-card">
        <div class="section-title">
          <i class="bi bi-table text-info me-2"></i>
          Current Student Data
        </div>

        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Level</th>
                <th>Total Students</th>
                <th>Courses with Data</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  <div class="spinner-border spinner-border-sm me-2"></div>
                  Loading data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed Save Button -->
  <button class="btn btn-primary btn-lg save-btn-fixed" onclick="saveAll()" id="saveAllBtn" style="display: none">
    <i class="bi bi-save-fill me-2"></i>Save All Changes
  </button>

  <!-- Alert Container -->
  <div id="alert-container"></div>

  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/api.js"></script>

  <script>
    // Auto-detect API URL based on environment (from api.js)
    const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
      ? "http://localhost:4000/api/students"
      : "/api/students";
    let currentCourses = [];
    let hasChanges = false;

    document.addEventListener("DOMContentLoaded", () => {
      loadUserInfo();
      setupSidebarToggle();
      setupLogout();
      loadCurrentData();
      setupMethodToggle();
      setupUploadHandlers();
      loadExistingLevelCounts();
    });

    function setupSidebarToggle() {
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");

      if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener("click", () => {
          sidebar.classList.toggle("active");
        });

        document.addEventListener("click", (e) => {
          if (window.innerWidth <= 992) {
            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
              sidebar.classList.remove("active");
            }
          }
        });
      }
    }

    function loadUserInfo() {
      const raw = sessionStorage.getItem("user");
      let user = null;
      try {
        user = raw ? JSON.parse(raw) : null;
      } catch (e) {
        console.warn("Could not parse user:", e);
      }

      const first = user?.First_Name ?? user?.firstName ?? "";
      const last = user?.Last_Name ?? user?.lastName ?? "";
      const displayName = [first, last].filter(Boolean).join(" ").trim() || "Committee Member";

      const displayEl = document.getElementById("sidebarUserName");
      const avatarEl = document.getElementById("userAvatar");

      if (displayEl) displayEl.textContent = displayName;
      if (avatarEl) {
        const initials = displayName.split(" ").map((n) => n[0]).join("").toUpperCase().substring(0, 2);
        avatarEl.textContent = initials || "CM";
      }
    }

    function setupLogout() {
      const logoutBtn = document.getElementById("logoutButton");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          sessionStorage.removeItem("user");
          sessionStorage.removeItem("token");
          window.location.href = "loginReg.html";
        });
      }
    }

    function setupMethodToggle() {
      document.getElementById("methodManual").addEventListener("change", function () {
        if (this.checked) {
          document.getElementById("manualEntrySection").style.display = "block";
          document.getElementById("uploadSection").style.display = "none";
        }
      });

      document.getElementById("methodUpload").addEventListener("change", function () {
        if (this.checked) {
          document.getElementById("manualEntrySection").style.display = "none";
          document.getElementById("uploadSection").style.display = "block";
        }
      });
    }

    async function loadExistingLevelCounts() {
      try {
        const response = await fetch(`${API_BASE}/levels`);
        const data = await response.json();

        if (data.success) {
          data.data.forEach((level) => {
            const input = document.getElementById(`level_${level.level_num}`);
            if (input && level.student_count) {
              input.value = level.student_count;
            }
          });
        }
      } catch (error) {
        console.error("Error loading level counts:", error);
      }
    }

    async function loadCourses() {
      const levelNum = document.getElementById("courseLevel").value;
      const container = document.getElementById("coursesContainer");

      if (!levelNum) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Please select a level to load courses
          </div>
        `;
        document.getElementById("manualSaveBtn").style.display = "none";
        return;
      }

      container.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div></div>';

      try {
        // استخدام نفس الـ endpoint من الكود القديم
        const response = await fetch(`${API_BASE}/levels`);
        const data = await response.json();

        if (data.success) {
          const level = data.data.find(l => l.level_num == levelNum);

          if (level && level.courses && level.courses.length > 0) {
            currentCourses = level.courses;

            container.innerHTML = `
              <div class="alert alert-success mb-3">
                <i class="bi bi-check-circle me-2"></i>
                Found ${level.courses.length} courses for Level ${levelNum}
              </div>
              <div id="coursesList"></div>
            `;

            const coursesList = document.getElementById("coursesList");
            coursesList.innerHTML = level.courses.map((course) => {
              const currentCount = level.course_enrollments[course.code] || "";
              return `
                <div class="course-item">
                  <span class="course-code">${course.code}</span>
                  <span class="course-name">${course.name}</span>
                  <input type="number" class="form-control" 
                         data-course-code="${course.code}" value="${currentCount}" 
                         min="0" placeholder="Count" onchange="markChanges()">
                </div>
              `;
            }).join("");

            document.getElementById("manualSaveBtn").style.display = "block";
          } else {
            container.innerHTML = `
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                No courses found for Level ${levelNum}
              </div>
            `;
            document.getElementById("manualSaveBtn").style.display = "none";
          }
        }
      } catch (error) {
        console.error("Error loading courses:", error);
        container.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-x-circle me-2"></i>
            Error loading courses
          </div>
        `;
      }
    }

    async function saveLevelCounts() {
      const levels = [3, 4, 5, 6, 7, 8];
      let successCount = 0;

      for (const levelNum of levels) {
        const input = document.getElementById(`level_${levelNum}`);
        const count = parseInt(input.value);

        if (count >= 0 && !isNaN(count)) {
          try {
            const response = await fetch(`${API_BASE}/level/${levelNum}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ student_count: count }),
            });

            const data = await response.json();
            if (data.success) successCount++;
          } catch (error) {
            console.error(`Error saving level ${levelNum}:`, error);
          }
        }
      }

      if (successCount > 0) {
        showAlert(`Successfully saved ${successCount} level(s)`, "success");
        loadCurrentData();
      } else {
        showAlert("No data to save or invalid input", "warning");
      }
    }

    async function saveCourseCounts() {
      const levelNum = document.getElementById("courseLevel").value;

      if (!levelNum) {
        showAlert("Please select a level", "warning");
        return;
      }

      const courseInputs = document.querySelectorAll("[data-course-code]");
      const courseEnrollments = {};

      courseInputs.forEach((input) => {
        const code = input.dataset.courseCode;
        const count = parseInt(input.value);
        if (count >= 0 && !isNaN(count)) {
          courseEnrollments[code] = count;
        }
      });

      if (Object.keys(courseEnrollments).length === 0) {
        showAlert("No valid counts entered.", "warning");
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/level/${levelNum}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ course_enrollments: courseEnrollments }),
        });

        const data = await response.json();

        if (data.success) {
          showAlert("Course counts saved successfully", "success");
          hasChanges = false;
          document.getElementById("saveAllBtn").style.display = "none";
          loadCurrentData();
        } else {
          showAlert(data.error || "Error saving data", "danger");
        }
      } catch (error) {
        console.error("Error saving:", error);
        showAlert("Error saving course counts", "danger");
      }
    }

    function setupUploadHandlers() {
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const uploadLevel = document.getElementById("uploadLevel");

      uploadArea.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      uploadLevel.addEventListener("change", checkUploadReady);
    }

    function handleFileSelect(file) {
      document.getElementById("fileName").textContent = file.name;
      document.getElementById("fileInfo").style.display = "block";
      checkUploadReady();
    }

    function removeFile() {
      document.getElementById("fileInput").value = "";
      document.getElementById("fileInfo").style.display = "none";
      document.getElementById("uploadBtn").disabled = true;
    }

    function checkUploadReady() {
      const hasFile = document.getElementById("fileInput").files.length > 0;
      const hasLevel = document.getElementById("uploadLevel").value !== "";
      document.getElementById("uploadBtn").disabled = !(hasFile && hasLevel);
    }

    async function uploadFile() {
      const fileInput = document.getElementById("fileInput");
      const levelNum = document.getElementById("uploadLevel").value;

      if (!fileInput.files[0] || !levelNum) {
        showAlert("Please select both file and level", "warning");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      formData.append("levelNum", levelNum);

      document.getElementById("uploadProgress").style.display = "block";
      document.getElementById("uploadBtn").disabled = true;

      try {
        const response = await fetch(`${API_BASE}/upload`, {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          showAlert("File processed successfully!", "success");
          fileInput.value = "";
          document.getElementById("uploadLevel").value = "";
          document.getElementById("fileInfo").style.display = "none";
          loadCurrentData();
        } else {
          showAlert(data.error || "Error processing file", "danger");
        }
      } catch (error) {
        console.error("Upload error:", error);
        showAlert("Error uploading file", "danger");
      } finally {
        document.getElementById("uploadProgress").style.display = "none";
        document.getElementById("uploadBtn").disabled = false;
      }
    }

    async function loadCurrentData() {
      try {
        const response = await fetch(`${API_BASE}/levels`);
        const data = await response.json();

        const tbody = document.getElementById("dataTableBody");

        if (data.success && data.data.length > 0) {
          tbody.innerHTML = data.data.map((level) => `
            <tr>
              <td><strong>Level ${level.level_num}</strong></td>
              <td>${level.student_count || 0} students</td>
              <td>${Object.keys(level.course_enrollments || {}).length} courses</td>
              <td>${level.updated_at ? new Date(level.updated_at).toLocaleString() : "N/A"}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger" onclick="clearLevelData(${level.level_num})">
                  <i class="bi bi-trash"></i> Clear
                </button>
              </td>
            </tr>
          `).join("");
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">No data available</td>
            </tr>
          `;
        }
      } catch (error) {
        console.error("Error loading data:", error);
      }
    }

    async function clearLevelData(levelNum) {
      if (!confirm(`Are you sure you want to clear all data for Level ${levelNum}?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/level/${levelNum}`, {
          method: "DELETE",
        });

        const data = await response.json();

        if (data.success) {
          showAlert("Data cleared successfully", "success");
          const levelInput = document.getElementById(`level_${levelNum}`);
          if (levelInput) levelInput.value = "";
          loadCurrentData();
        } else {
          showAlert(data.error || "Error clearing data", "danger");
        }
      } catch (error) {
        console.error("Error:", error);
        showAlert("Error clearing data", "danger");
      }
    }

    function markChanges() {
      hasChanges = true;
      document.getElementById("saveAllBtn").style.display = "block";
    }

    function saveAll() {
      saveCourseCounts();
    }

    function showAlert(message, type = "info") {
      let container = document.getElementById("alert-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "alert-container";
        container.style.position = "fixed";
        container.style.top = "1rem";
        container.style.right = "1rem";
        container.style.zIndex = "9999";
        document.body.appendChild(container);
      }

      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.style.minWidth = "300px";
      alertDiv.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      container.appendChild(alertDiv);

      setTimeout(() => alertDiv.remove(), 4000);
    }
  </script>

  <!-- Notifications Modal -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
          <div class="d-flex align-items-center gap-3">
            <i class="bi bi-bell-fill fs-3"></i>
            <div>
              <h5 class="modal-title fw-bold mb-0">Notifications & Deadlines</h5>
              <small class="opacity-75">Stay updated with your schedule</small>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <ul class="nav nav-tabs nav-fill border-bottom">
            <li class="nav-item">
              <button class="nav-link active fw-semibold" data-bs-toggle="tab" data-bs-target="#notifications-content">
                <i class="bi bi-bell me-2"></i>Notifications
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link fw-semibold" data-bs-toggle="tab" data-bs-target="#deadlines-content">
                <i class="bi bi-calendar-event me-2"></i>Deadlines
              </button>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notifications-content">
              <div id="notificationsList" style="max-height: 500px; overflow-y: auto;">
                <div class="text-center py-5">
                  <div class="spinner-border text-primary"></div>
                  <p class="text-muted mt-3">Loading...</p>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="deadlines-content">
              <div id="deadlinesList" style="max-height: 500px; overflow-y: auto;">
                <div class="text-center py-5">
                  <div class="spinner-border text-primary"></div>
                  <p class="text-muted mt-3">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <small class="text-muted me-auto">
            <i class="bi bi-info-circle me-1"></i>Last updated: Just now
          </small>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Scripts -->
  <script src="assets/js/notifications-util.js"></script>
  <script src="assets/js/notifications.js"></script>
</body>
</html>
